name: Copilot PR Review and Record

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  record-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR information
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "datetime=$(date '+%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: Get changed files with details
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // ê° íŒŒì¼ì˜ ë³€ê²½ ì •ë³´ ìˆ˜ì§‘
            const fileDetails = files.map(f => {
              let changeType = '';
              if (f.status === 'added') {
                changeType = 'ì¶”ê°€';
              } else if (f.status === 'removed') {
                changeType = 'ì‚­ì œ';
              } else if (f.status === 'modified') {
                changeType = 'ìˆ˜ì •';
              } else if (f.status === 'renamed') {
                changeType = 'ì´ë¦„ë³€ê²½';
              } else {
                changeType = 'ë³€ê²½';
              }

              return {
                filename: f.filename,
                status: f.status,
                changeType: changeType,
                additions: f.additions,
                deletions: f.deletions,
                changes: f.changes,
                patch: f.patch || ''
              };
            });

            return fileDetails;

      - name: Update REVIEW_HISTORY.md
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          DATE: ${{ steps.pr-info.outputs.date }}
          DATETIME: ${{ steps.pr-info.outputs.datetime }}
        run: |
          FILES='${{ steps.files.outputs.result }}'

          echo "" >> .github/REVIEW_HISTORY.md
          echo "### PR #${PR_NUMBER} - ${DATETIME}" >> .github/REVIEW_HISTORY.md

          # ê° íŒŒì¼ì˜ ìƒì„¸ ì •ë³´ë¥¼ ê¸°ë¡
          echo "$FILES" | jq -c '.[]' | while read -r file_json; do
            filename=$(echo "$file_json" | jq -r '.filename')
            changeType=$(echo "$file_json" | jq -r '.changeType')
            additions=$(echo "$file_json" | jq -r '.additions')
            deletions=$(echo "$file_json" | jq -r '.deletions')

            # ë³€ê²½ ë‚´ìš© ìš”ì•½ ìƒì„±
            if [ "$additions" -gt 0 ] && [ "$deletions" -gt 0 ]; then
              changeDesc="${changeType}: +${additions}ì¤„ -${deletions}ì¤„"
            elif [ "$additions" -gt 0 ]; then
              changeDesc="${changeType}: +${additions}ì¤„"
            elif [ "$deletions" -gt 0 ]; then
              changeDesc="${changeType}: -${deletions}ì¤„"
            else
              changeDesc="${changeType}"
            fi

            echo "- \`${DATE} | ${filename} | ${changeDesc} â†’ ğŸ”„ ê²€í† ì¤‘\`" >> .github/REVIEW_HISTORY.md
          done

          echo "" >> .github/REVIEW_HISTORY.md
          echo "---" >> .github/REVIEW_HISTORY.md

      - name: Commit changes
        run: |
          git config --local user.name 'github-actions[bot]'
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'

          if git diff --quiet .github/REVIEW_HISTORY.md; then
            echo "No changes to commit"
          else
            git add .github/REVIEW_HISTORY.md
            git commit -m "ğŸ“ Update REVIEW_HISTORY.md for PR #${{ steps.pr-info.outputs.pr_number }}"
            git push
          fi

      - name: Add PR comment
        uses: actions/github-script@v7
        env:
          PR_NUM: ${{ steps.pr-info.outputs.pr_number }}
        with:
          script: |
            const prNumber = process.env.PR_NUM;
            const commentBody = [
              'ğŸ¤– **Copilot ìë™ ë¦¬ë·° ê¸°ë¡**',
              '',
              'ì´ PRì˜ ë¦¬ë·° ì •ë³´ê°€ `.github/REVIEW_HISTORY.md`ì— ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
              '',
              '**ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ë ¤ë©´:**',
              '- ì´ PRì— `@github-copilot`ë¥¼ ë©˜ì…˜í•˜ì—¬ ì§ˆë¬¸í•˜ì„¸ìš”',
              '- GitHub Copilot ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì„¸ìš”',
              '',
              '**ì°¸ê³ ì‚¬í•­:**',
              '- ì½”ë“œ í’ˆì§ˆ, ë³´ì•ˆ, ì„±ëŠ¥ ê°œì„  ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”',
              '- ë¦¬ë·° í›„ REVIEW_HISTORY.mdì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”',
              '  - âœ… ìˆ˜ì •ì™„ë£Œ',
              '  - ğŸ”„ ê²€í† ì¤‘',
              '  - âŒ ë¯¸ìˆ˜ì •',
              '  - âš ï¸ ë³´ì•ˆ ì´ìŠˆ',
              '  - ğŸš€ ì„±ëŠ¥ ê°œì„ '
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: commentBody
            });

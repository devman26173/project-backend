---
name: PR File Change Checker

"on":
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-file-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          git fetch origin ${{ github.base_ref }}
          FILES=$(git diff --name-only \
            origin/${{ github.base_ref }}...HEAD)
          echo "$FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check file ownership
        id: check-ownership
        run: |
          FILES="${{ steps.changed-files.outputs.changed_files }}"

          # ê° ì˜ì—­ë³„ íŒŒì¼ íŒ¨í„´ ì •ì˜
          POST_PATTERN="Post|post"
          FOODBOARD_PATTERN="FoodBoard|foodboard"
          USER_PATTERN="User|user|login|signup"
          PROFILE_PATTERN="Profile|profile"

          # ì˜ì—­ë³„ ë³€ê²½ íŒŒì¼ í™•ì¸
          POST_FILES=$(echo "$FILES" | \
            grep -iE "$POST_PATTERN" || true)
          FOODBOARD_FILES=$(echo "$FILES" | \
            grep -iE "$FOODBOARD_PATTERN" || true)
          USER_FILES=$(echo "$FILES" | \
            grep -iE "$USER_PATTERN" || true)
          PROFILE_FILES=$(echo "$FILES" | \
            grep -iE "$PROFILE_PATTERN" || true)
          PATTERN="$POST_PATTERN|$FOODBOARD_PATTERN"
          PATTERN="$PATTERN|$USER_PATTERN|$PROFILE_PATTERN"
          OTHER_FILES=$(echo "$FILES" | \
            grep -viE "$PATTERN" || true)

          # ê²°ê³¼ë¥¼ outputì— ì €ì¥
          echo "post_files<<EOF" >> $GITHUB_OUTPUT
          echo "$POST_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "foodboard_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FOODBOARD_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "user_files<<EOF" >> $GITHUB_OUTPUT
          echo "$USER_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "profile_files<<EOF" >> $GITHUB_OUTPUT
          echo "$PROFILE_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "other_files<<EOF" >> $GITHUB_OUTPUT
          echo "$OTHER_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const postFiles = `${{
              steps.check-ownership.outputs.post_files
            }}`.trim();
            const foodboardFiles = `${{
              steps.check-ownership.outputs.foodboard_files
            }}`.trim();
            const userFiles = `${{
              steps.check-ownership.outputs.user_files
            }}`.trim();
            const profileFiles = `${{
              steps.check-ownership.outputs.profile_files
            }}`.trim();
            const otherFiles = `${{
              steps.check-ownership.outputs.other_files
            }}`.trim();

            let comment = '## ğŸ“‹ PR íŒŒì¼ ë³€ê²½ ë‚´ì—­\n\n';
            comment += 'ì´ PRì—ì„œ ìˆ˜ì •ëœ íŒŒì¼ë“¤ì„ ';
            comment += 'ë‹´ë‹¹ìë³„ë¡œ ë¶„ë¥˜í–ˆìŠµë‹ˆë‹¤.\n\n';

            if (postFiles) {
              comment += '### ğŸ”µ Post ê´€ë ¨ íŒŒì¼ ';
              comment += '(ë‹´ë‹¹: ì„ í–¥)\n';
              comment += '```\n' + postFiles + '\n```\n\n';
            }

            if (foodboardFiles) {
              comment += '### ğŸŸ¢ FoodBoard ê´€ë ¨ íŒŒì¼ ';
              comment += '(ë‹´ë‹¹: í˜„ì£¼)\n';
              comment += '```\n' + foodboardFiles + '\n```\n\n';
            }

            if (userFiles) {
              comment += '### ğŸŸ¡ User/Login/Signup ê´€ë ¨ íŒŒì¼ ';
              comment += '(ë‹´ë‹¹: ìˆ˜ì§„)\n';
              comment += '```\n' + userFiles + '\n```\n\n';
            }

            if (profileFiles) {
              comment += '### ğŸŸ£ Profile ê´€ë ¨ íŒŒì¼ ';
              comment += '(ë‹´ë‹¹: ë¯¼ì°½)\n';
              comment += '```\n' + profileFiles + '\n```\n\n';
            }

            if (otherFiles) {
              comment += '### âšª ê¸°íƒ€ ê³µí†µ íŒŒì¼\n';
              comment += '```\n' + otherFiles + '\n```\n\n';
            }

            // ì—¬ëŸ¬ ì˜ì—­ì˜ íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const areas = [
              postFiles,
              foodboardFiles,
              userFiles,
              profileFiles
            ].filter(f => f).length;
            if (areas > 1 || otherFiles) {
              comment += '---\n';
              comment += 'âš ï¸ **ì£¼ì˜**: ì´ PRì€ ì—¬ëŸ¬ ë‹´ë‹¹ ì˜ì—­ì˜ ';
              comment += 'íŒŒì¼ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ê³µí†µ íŒŒì¼ì„ í¬í•¨í•©ë‹ˆë‹¤.\n';
              comment += 'í•´ë‹¹ ì˜ì—­ì˜ ë‹´ë‹¹ìë“¤ì´ ';
              comment += 'ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.\n';
            }

            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } =
              await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ“‹ PR íŒŒì¼ ë³€ê²½ ë‚´ì—­')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

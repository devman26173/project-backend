<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>æŠ•ç¨¿ä¿®æ­£ - FoodBoard</title>

	<!--Bootstrap CSS-->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" th:href="@{/css/bottom-nav.css}">
	<style>
		.mobile-container {
		            max-width: 430px;
		            margin: 0 auto;
		            min-height: 100vh;
		            background-color: #ffffff;
		            border-left: 1px solid #f0f0f0;
		            border-right: 1px solid #f0f0f0;
		            display: flex;
		            flex-direction: column;
		            padding: 0;
		        }

		        /* ìŠ¤í¬ë¡¤ ì‹œ í—¤ë” ê³ ì • */
		        header {
		            position: sticky;
		            top: 0;
		            z-index: 1020;
		            width: 100%;
		        }
	  </style>
</head>	
<body>
	<div class="container-fluid px-0">
		<div class="mobile-container">
			<form th:action="@{/board/edit/{id}(id=${board.id})}" method="post">
				
				<!--ì£¼í™©ìƒ‰ í—¤ë” ë¶€ë¶„-->
				<header class="d-flex justify-content-between align-items-center py-3 px-3"
						style="background-color: #ffecd9; min-height: 85px;">
				<!--ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼-->
				<a th:href="@{/board/view/{id}(id=${board.id})}"
				   class="d-inline-flex align-items-center justify-content-center" 
				   style="cursor: pointer; font-size: 24px; line-height: 1; width: 24px; height: 24px; text-decoration: none; color: black;">ã€ˆ</a>
				<h5 class="mb-0 fw-bold">æŠ•ç¨¿ä¿®æ­£</h5>
				<button type="submit" class="btn p-0 fw-bold" 
						style="font-size: 16px; color: black; border: none; background: none;">å®Œäº†</button>
				</header>
				
				<!--ì œëª©-->
				<div class="mt-3 px-3">		
					<input type="text" name="title"
						th:value="${board.title}"
						class="form-control border-0 fs-5"
						placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
						<hr class="mt-1">
				</div>
				
				<!--ì§€ì—­ ì„ íƒ-->
				<div class="mt-3 px-3">
					<div class="border rounded p-3 bg-light" style="background-color: #f8f9fa;">
						<div class="small mb-2 text-muted">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</div>
						
						<div class = "d-flex gap-2 mb-2">
							<select class="form-select" id="regionSelect" name="region">
								<option value="" disabled>åœ°æ–¹ã‚’é¸æŠ</option>	
								<option value="åŒ—æµ·é“ãƒ»æ±åŒ—" th:selected="${board.region == 'åŒ—æµ·é“ãƒ»æ±åŒ—'}">åŒ—æµ·é“ãƒ»æ±åŒ—</option>
								<option value="é–¢æ±" th:selected="${board.region == 'é–¢æ±'}">é–¢æ±</option>	
								<option value="ä¸­éƒ¨" th:selected="${board.region == 'ä¸­éƒ¨'}">ä¸­éƒ¨</option>
								<option value="è¿‘ç•¿" th:selected="${board.region == 'è¿‘ç•¿'}">è¿‘ç•¿</option>
								<option value="ä¸­å›½ãƒ»å››å›½" th:selected="${board.region == 'ä¸­å›½ãƒ»å››å›½'}">ä¸­å›½ãƒ»å››å›½</option>
								<option value="ä¹å·ãƒ»æ²–ç¸„" th:selected="${board.region == 'ä¹å·ãƒ»æ²–ç¸„'}">ä¹å·ãƒ»æ²–ç¸„</option>
							</select>
				
					 <select class="form-select" id="prefectureSelect" name="prefecture">
					<option value="" disabled>éƒ½é“åºœçœŒ</option>
					
					
				</select>
			</div>
			<!--ê²½ê³  ë©”ì‹œì§€-->
			<small class="text-danger">â€» åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</small>
			</div>
		</div>

		<!--ë³„ì  ì„ íƒ-->
		<div class = "mt-3 px-3">
			<div class="border rounded p-3" style="background-color: #f8f9fa;">
				<div class="mb-2">è©•ä¾¡ã‚’é¸æŠ</div>
				<div class="d-flex gap-2">
					<span class="star" style="cursor:pointer; font-size: 24px;">â˜†</span>
					<span class="star" style="cursor:pointer; font-size: 24px;">â˜†</span>
					<span class="star" style="cursor:pointer; font-size: 24px;">â˜†</span>
					<span class="star" style="cursor:pointer; font-size: 24px;">â˜†</span>
					<span class="star" style="cursor:pointer; font-size: 24px;">â˜†</span>
					<input type="hidden" name="rating" id="ratingInput" th:value="${board.rating}">
				</div>
			</div>
		</div>
		
		<div class="mt-3 px-3">
			<textarea name="content" class="form-control border"
			          placeholder="å†…å®¹ã‚’å…¥åŠ›"
			          rows="10" 
			          style="resize: none;" 
			          th:text="${board.content}"></textarea>
		</div>
		
		<div class="mt-3 px-3 mb-5">
			<div class="border rounded p-3" style="background-color: #f8f9fa;">
				<div class="mb-2">ç”»åƒã‚’è¿½åŠ  (æœ€å¤§5æš)</div>
				
				<!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ -->
				<div id="existingImagesContainer">
				    <div id="existingImagesHeader" class="mb-2 small text-muted" style="display: none;">ç¾åœ¨ã®ç”»åƒ:</div>
				    <div id="existingImages" class="d-flex flex-wrap gap-2 mb-3"></div>
				</div>
				
				<!--íŒŒì¼ ì„ íƒ ë²„íŠ¼-->
				<input type="file" id="imageInput" accept="image/*" capture="environment" multiple style="display: none;">
				<button type="button" class="btn btn-warning w-100 mb-2" onclick="document.getElementById('imageInput').click()">
					ğŸ“· ç”»åƒã‚’é¸æŠ(è¤‡æ•°å¯)
				 </button>
				 
				<!--ë“œë˜ê·¸ì•¤ë“œë¡­-->
				<div id="dropZone" class="border border-2 border-dashed rounded p-3 text-center" style="cursor: pointer; background-color: white;">
					<p class="mb-0 text-muted small">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / è²¼ã‚Šä»˜ã‘ (Ctrl+V)</p>
				</div>
				
				<!--ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°-->	
				<div id="imagePreviewContainer" class="mt-3" style="display: none;">
					<div class="mb-2 small text-muted">è¿½åŠ ã™ã‚‹ç”»åƒ:</div>
					<div id="imagePreviewList" class="d-flex flex-wrap gap-2"></div>
					</div>
					
					<!--ìµœì¢… ì´ë¯¸ì§€ urlë“¤(hidden)-->
					<input type="hidden" name="imageUrls" id="imageUrls" th:value="${board.imageUrls}">
					 </div>
					</div>
				
	</form>
</div>
</div>

<!--Bootstrap JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
	// ë³„ì  ê¸°ëŠ¥
	const stars = document.querySelectorAll('.star');
	const ratingInput = document.getElementById('ratingInput');
	const currentRating = parseInt(ratingInput.value) || 0;
	
	//í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë³„ì  í‘œì‹œ 
	for(let i = 0; i < currentRating; i++){
		stars[i].textContent = 'â˜…';
		}
		
	stars.forEach(function(star, index){
		star.addEventListener('click', function(){
			const rating = index + 1; 
			ratingInput.value = rating; 
			stars.forEach(function(s){s.textContent = 'â˜†'; });
			for(let i = 0 ; i <= index ; i++ ){
				stars[i].textContent = 'â˜…';
			}
		});
	});
	
	//ì§€ì—­ ë°ì´í„° 
	const regionData = {
	           'åŒ—æµ·é“ãƒ»æ±åŒ—': ['åŒ—æµ·é“', 'é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ'],
	           'é–¢æ±': ['æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ', 'åƒè‘‰çœŒ', 'åŸ¼ç‰çœŒ', 'èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ'],
	           'ä¸­éƒ¨': ['æ„›çŸ¥çœŒ', 'é™å²¡çœŒ', 'å²é˜œçœŒ', 'ä¸‰é‡çœŒ', 'æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ'],
	           'è¿‘ç•¿': ['å¤§é˜ªåºœ', 'å…µåº«çœŒ', 'äº¬éƒ½åºœ', 'æ»‹è³€çœŒ', 'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ'],
	           'ä¸­å›½ãƒ»å››å›½': ['é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ', 'å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ'],
	           'ä¹å·ãƒ»æ²–ç¸„': ['ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ', 'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ', 'æ²–ç¸„çœŒ']
	       };
		   const regionSelect = document.getElementById('regionSelect');
		   const prefectureSelect = document.getElementById('prefectureSelect');
		   const currentPrefecture = '[[${board.prefecture}]]'; // Thymeleafë¡œ í˜„ì¬ ë„ì‹œ ê°€ì ¸ì˜¤ê¸°
		   
		   function loadPrefectures(region, selectedPref){
			prefectureSelect.innerHTML = '<option value = "" disabled>éƒ½é“åºœçœŒ</option>';
			const prefectures = regionData[region];
			
			if(prefectures){
				prefectures.forEach(function(prefecture){
					const option = document.createElement('option');
					option.value = prefecture;
					option.textContent = prefecture; 
					if(selectedPref && prefecture === selectedPref){
						option.selected = true;
					}
					prefectureSelect.appendChild(option);
				});
			}
		   }
		   
		   regionSelect.addEventListener('change', function(){
			const selectedRegion = this.value; 
			loadPrefectures(selectedRegion, null);
		   })
		   
		   //í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ ì§€ì—­ì˜ ë„ì‹œ ëª©ë¡ ë¡œë“œ 
		   window.addEventListener('DOMContentLoaded', function() {
		           const initialUrls = imageUrlsInput.value;
		           if (initialUrls && initialUrls.trim() !== '') {
		               existingImageUrls = initialUrls.split(',').map(url => url.trim());
		               updateExistingImages();
		           }
		       });
		</script>
		<script>
		    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›ë³¸ ë°ì´í„° ì €ì¥
		    let originalData = {
		        title: document.querySelector('input[name="title"]').value,
		        region: document.getElementById('regionSelect').value,
		        prefecture: document.getElementById('prefectureSelect').value,
		        rating: document.getElementById('ratingInput').value,
		        content: document.querySelector('textarea[name="content"]').value,
		        imageUrls: document.querySelector('input[name="imageUrls"]').value
		    };
		    
			
			
		    // í˜„ì¬ ë°ì´í„°ì™€ ë¹„êµí•˜ëŠ” í•¨ìˆ˜
		    function hasChanges() {
		        let currentData = {
		            title: document.querySelector('input[name="title"]').value,
		            region: document.getElementById('regionSelect').value,
		            prefecture: document.getElementById('prefectureSelect').value,
		            rating: document.getElementById('ratingInput').value,
		            content: document.querySelector('textarea[name="content"]').value,
		            imageUrls: document.querySelector('input[name="imageUrls"]').value
		        };
				
		        
		        // í•˜ë‚˜ë¼ë„ ë‹¤ë¥´ë©´ true ë°˜í™˜
		        return originalData.title !== currentData.title ||
		               originalData.region !== currentData.region ||
		               originalData.prefecture !== currentData.prefecture ||
		               originalData.rating !== currentData.rating ||
		               originalData.content !== currentData.content ||
		               originalData.imageUrls !== currentData.imageUrls;
		    }
		    
		    
		    
		    // form ì œì¶œ ì‹œì—ëŠ” ê²½ê³  ì•ˆ ëœ¨ê²Œ
		    const form = document.querySelector('form');
		    let isSubmitting = false;
		    
		    form.addEventListener('submit', function() {
		        isSubmitting = true;
		    });
		    
		    // ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨/ë‹«ê¸° ì‹œì—ë„ ê²½ê³ 
		    window.addEventListener('beforeunload', function(e) {
		        if (hasChanges() && !isSubmitting) {
		            e.preventDefault();
		            e.returnValue = ''; // Chromeì—ì„œ í•„ìš”
		        }
		    });
		</script>
		<script>
			const imageInput = document.getElementById('imageInput');
			const dropZone = document.getElementById('dropZone');
			const imagePreviewContainer = document.getElementById('imagePreviewContainer');
			const imagePreviewList = document.getElementById('imagePreviewList');
			const imageUrlsInput = document.getElementById('imageUrls');
			const existingImages = document.getElementById('existingImages');
			
			let existingImageUrls = [];
			let newImageUrls = [];
			const MAX_IMAGES = 5; 
			
			//í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ 
			window.addEventListener('DOMContentLoaded', function(){
				const initialUrls = imageUrlsInput.value; 
				if(initialUrls && initialUrls.trim() !== ''){
					existingImageUrls = initialUrls.split(',').map(url => url.trim());
					updateExistingImages();
				}
			});
			
			// ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ
			    function updateExistingImages() {
			        if (!existingImages) return;
			        
			        existingImages.innerHTML = '';
					 const header = document.getElementById('existingImagesHeader');
					    if (existingImageUrls.length > 0 && header) {
					        header.style.display = 'block';
					    } else if (header) {
					        header.style.display = 'none';
					    }
					    
					    existingImageUrls.forEach((url, index) => {
					        const imageWrapper = document.createElement('div');
					        imageWrapper.className = 'position-relative';
					        imageWrapper.style.width = '100px';
					        
					        imageWrapper.innerHTML = `
					            <img src="${url}" class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
					            <button type="button" 
					                    class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
					                    style="padding: 2px 6px; font-size: 12px;"
					                    onclick="removeExistingImage(${index})">
					                âœ•
					            </button>
					        `;
					        
					        existingImages.appendChild(imageWrapper);
					    });
					    
					    updateImageUrlsInput();
					}
			    
			    // ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
			    window.removeExistingImage = function(index) {
			        existingImageUrls.splice(index, 1);
			        updateExistingImages();
			    };
			    
			    // íŒŒì¼ ì„ íƒ ì‹œ
			    imageInput.addEventListener('change', function(e) {
			        const files = Array.from(e.target.files);
			        uploadMultipleImages(files);
			    });
			    
			    // ë“œë˜ê·¸ ì˜¤ë²„
			    dropZone.addEventListener('dragover', function(e) {
			        e.preventDefault();
			        dropZone.style.backgroundColor = '#fff3cd';
			        dropZone.style.borderColor = '#ffc107';
			    });
			    
			    // ë“œë˜ê·¸ leave
			    dropZone.addEventListener('dragleave', function(e) {
			        e.preventDefault();
			        dropZone.style.backgroundColor = 'white';
			        dropZone.style.borderColor = '#dee2e6';
			    });
			    
			    // ë“œë¡­
			    dropZone.addEventListener('drop', function(e) {
			        e.preventDefault();
			        dropZone.style.backgroundColor = 'white';
			        dropZone.style.borderColor = '#dee2e6';
			        
			        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
			        if (files.length > 0) {
			            uploadMultipleImages(files);
			        } else {
			            alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™');
			        }
			    });
			    
			    // ë¶™ì—¬ë„£ê¸°
			    document.addEventListener('paste', function(e) {
			        const items = Array.from(e.clipboardData.items);
			        const imageFiles = items
			            .filter(item => item.type.startsWith('image/'))
			            .map(item => item.getAsFile());
			        
			        if (imageFiles.length > 0) {
			            uploadMultipleImages(imageFiles);
			        }
			    });
			    
			    // ì—¬ëŸ¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ
			    function uploadMultipleImages(files) {
			        const totalImages = existingImageUrls.length + newImageUrls.length + files.length;
			        if (totalImages > MAX_IMAGES) {
			            alert(`ç”»åƒã¯æœ€å¤§${MAX_IMAGES}æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™`);
			            return;
			        }
			        
			        files.forEach(file => uploadSingleImage(file));
			    }
			    
			    // ë‹¨ì¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ
			    function uploadSingleImage(file) {
			        if (file.size > 10 * 1024 * 1024) {
			            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
			            return;
			        }
			        
			        showLoading();
			
			        fetch('/api/uploads/presign', {
			            method: 'POST',
			            headers: {
			                'Content-Type': 'application/json'
			            },
			            body: JSON.stringify({
			                fileName: file.name,
			                contentType: file.type,
			                fileSize: file.size
			            })
			        })
			        .then(response => {
			            if (!response.ok) {
			                throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
			            }
			            return response.json();
			        })
			        .then(data => fetch(data.uploadUrl, {
			            method: 'PUT',
			            headers: {
			                'Content-Type': file.type
			            },
			            body: file
			        }).then(uploadResponse => {
			            if (!uploadResponse.ok) {
			                throw new Error('R2ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
			            }
			            return data;
			        }))
			        .then(data => {
			            if (data.publicUrl) {
			                newImageUrls.push(data.publicUrl);
			                updateNewImagePreview();
			                updateImageUrlsInput();
			            } else {
			                alert(data.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—');
			            }
			            hideLoading();
			        })
			        .catch(error => {
			            alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
			            console.error('Upload error:', error);
			            hideLoading();
			        });
			    }
			    
			    // ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
			    function updateNewImagePreview() {
			        imagePreviewList.innerHTML = '';
			        
			        newImageUrls.forEach((url, index) => {
			            const imageWrapper = document.createElement('div');
			            imageWrapper.className = 'position-relative';
			            imageWrapper.style.width = '100px';
			            
			            imageWrapper.innerHTML = `
			                <img src="${url}" class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
			                <button type="button" 
			                        class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
			                        style="padding: 2px 6px; font-size: 12px;"
			                        onclick="removeNewImage(${index})">
			                    âœ•
			                </button>
			            `;
			            
			            imagePreviewList.appendChild(imageWrapper);
			        });
			        
			        imagePreviewContainer.style.display = newImageUrls.length > 0 ? 'block' : 'none';
			    }
			    
			    // ìƒˆ ì´ë¯¸ì§€ ì‚­ì œ
			    window.removeNewImage = function(index) {
			        newImageUrls.splice(index, 1);
			        updateNewImagePreview();
			        updateImageUrlsInput();
			        imageInput.value = '';
			    };
			    
			    // hidden input ì—…ë°ì´íŠ¸
			    function updateImageUrlsInput() {
			        const allUrls = [...existingImageUrls, ...newImageUrls];
			        imageUrlsInput.value = allUrls.join(',');
			    }
			    
			    // ë¡œë”© í‘œì‹œ
			    function showLoading() {
			        dropZone.innerHTML = '<p class="mb-0"><span class="spinner-border spinner-border-sm me-2"></span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
			    }
			    
			    // ë¡œë”© ìˆ¨ê¸°ê¸°
			    function hideLoading() {
			        dropZone.innerHTML = `
			            <p class="mb-0 text-muted small">
			                ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / è²¼ã‚Šä»˜ã‘ (Ctrl+V)
			            </p>
			        `;
			    }
			</script>


	</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/post.css}">
    <link rel="stylesheet" th:href="@{/css/bottom-nav.css}">
</head>
<body>
	<div class="container-fluid px-0">
	  <div class="mx-auto bg-white min-vh-100 border-start border-end"
	       style="max-width:430px; padding-bottom: 70px;">
	  
	  <!-- 헤더 추가 -->
	  <header class="bg-white border-bottom py-3 px-3 d-flex justify-content-between align-items-center">
	      <a th:href="@{/board/view/{id}(id=${post.id})}"
	         class="d-inline-flex align-items-center justify-content-center" 
	         style="cursor: pointer; font-size: 24px; line-height: 1; width: 24px; height: 24px; text-decoration: none; color: black;"
	         aria-label="戻る">〈</a>
	      <span class="fw-bold fs-5">ポスト</span>
	      
	      <div>
	          <!-- 로그인 상태일 때 -->
	          <div th:if="${session.loginUser != null}">
	              <div th:replace="~{logout :: logoutButton}">
	                  <button class="btn btn-sm btn-outline-secondary">LOGOUT</button>
	              </div>
	          </div>
	          
	          <!-- 비로그인 상태일 때 - returnUrl 포함 -->
	          <div th:if="${session.loginUser == null}">
	              <a th:href="@{/login(returnUrl='/post')}" 
	                 class="btn btn-sm btn-outline-primary"
	                 style="font-size: 0.8rem; border-radius: 20px; padding: 4px 12px; text-decoration:none; font-weight: 500;">
	                 LOGIN
	              </a>
	          </div>
	      </div>
	  </header>
	  
    <!-- 게시글 카드 -->
	<div class="bg-white px-3 py-3 border-bottom">
		<div class="d-flex align-items-center gap-2 mb-2">
            <div class="profile"></div>
            <div class="fw-semibold"> ユーザー</div>
        </div>
        <div class="mb-3" th:text="${post.content}">
            ポスト内容です
        </div>
		<div class="d-flex gap-3 text-muted small">
			 <!-- 좋아요 버튼 -->
			 <form th:action="@{/board/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
			     <input type="hidden" name="boardId" th:value="${post.id}">
			             <button type="submit" class="btn-action d-flex align-items-center gap-1">
			                 <img th:src="${post.likedByMe ? 'https://img.icons8.com/ios-filled/20/ff6b6b/like.png' : 'https://img.icons8.com/ios/20/888888/like.png'}" 
			                      alt="いいね" 
			                      style="width:16px; height:16px;">
			                 <span>いいね！</span>
			                 <span th:text="${post.likeCount}">0</span>
			             </button>
			         </form>
					 
			    <!-- 댓글 버튼 -->
				<span onclick="toggleCommentSection()" 
				              style="cursor:pointer;" 
				              class="d-flex align-items-center gap-1">
				            <img src="https://img.icons8.com/ios/20/888888/comments.png" 
				                 alt="コメント" 
				                 style="width:16px; height:16px;">
				            <span>コメント</span>
				            <span th:text="${commentCount}">0</span>
				        </span>
				    </div>
				</div>

    <!-- 댓글 섹션 -->
    <div id="comment-section" style="display:none;">
		<!-- 댓글 입력 -->
		<div class="border-bottom px-3 py-3">
			<form th:action=			"@{/board/comment/add}" method="post" onsubmit="return checkLoginForAction(event)">
			    <input type="hidden" name="boardId" th:value="${post.id}">
			    <input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
			    <textarea id="commentInput" 
			              name="content" 
			              class="form-control mb-2" 
			              placeholder="コメントを入力してください"
			              onclick="checkLoginForClick(event)" 
			              required></textarea>
			    <button type="submit"
			            class="btn btn-primary w-100 fw-bold rounded-pill py-2">
			      登록
			    </button>
			</form>
		</div>

        <!-- 정렬 버튼 -->
		<div class="px-3 py-3">  <!-- border-bottom 제거! -->
		        <div class="d-flex justify-content-end gap-2">
		            <button type="button" 
		                    class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
		                    id="sort-newest" 
		                    onclick="sortComments('newest')">
		                新着順
		            </button>
		            <button type="button" 
		                    class="btn btn-sm btn-outline-secondary rounded-pill px-3" 
		                    id="sort-oldest" 
		                    onclick="sortComments('oldest')">
		                投稿順
		            </button>
		        </div>
		    </div>
			
		<!-- 댓글 리스트 -->
		<div class="comment-list">
		    <!-- ✅ 수정: ${post.comments} → ${comments} -->
		    <div class="comment px-3 py-3 border-bottom" th:each="comment : ${comments}">

				<div class="d-flex align-items-center gap-2 mb-2">
				            <!-- 프로필 이미지 -->
				            <div th:if="${comment.user != null && comment.user.profileImageUrl != null}"
				                 class="profile small"
				                 th:style="'background-image: url(' + ${comment.user.profileImageUrl} + '); background-size: cover; background-position: center;'">
				            </div>
				            <div th:unless="${comment.user != null && comment.user.profileImageUrl != null}"
				                 class="profile small">
				            </div>
				            
				            <!-- 사용자 이름 -->
				            <span class="fw-semibold" 
				                  th:text="${comment.user != null ? comment.user.name : comment.author}">
				                ユーザー
				            </span>
				            
				            <span class="text-muted small" 
				                  th:text="${comment.createdAt != null ? #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:30'}">
				                2026-01-19 14:30
				            </span>
				        </div>
                
                <!-- 댓글 내용 -->
                <div class="mb-2" th:text="${comment.content}" 
                     th:id="'comment-content-' + ${comment.id}">
                    コメント内容
                </div>
                
                <!-- 댓글 수정 폼 -->
                <div class="edit-form" th:id="'edit-form-' + ${comment.id}">
                    <form th:action="@{/board/comment/edit}" method="post" onsubmit="return checkLoginForAction(event)">
                        <input type="hidden" name="commentId" th:value="${comment.id}">
						<input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
                        <textarea name="content" class="form-control mb-2" th:text="${comment.content}" required></textarea>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-sm btn-primary">保存</button>
                            <button type="button" class="btn btn-sm btn-secondary"
                                    th:onclick="'toggleEdit(' + ${comment.id} + ')'">キャンセル</button>
                        </div>
                    </form>
                </div>
                
                <!-- 댓글 액션 -->
                <div class="comment-actions d-flex align-items-center gap-2">
					 <!-- 좋아요 -->
					 <form th:action="@{/board/comment/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
					         <input type="hidden" name="commentId" th:value="${comment.id}">
							 <input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
					         <button type="submit" class="btn-action d-flex align-items-center gap-1">
					             <img th:src="${comment.likedByMe ? 'https://img.icons8.com/ios-filled/18/ff6b6b/like.png' : 'https://img.icons8.com/ios/18/888888/like.png'}" 
					                  alt="いいね" 
					                  style="width:14px; height:14px;">
					             <span th:text="${comment.likeCount}">0</span>
					         </button>
					     </form>
					     
						 <!-- ✅ 수정: 대댓글 수 표시 -->
						     <span th:onclick="'toggleReply(' + ${comment.id} + ')'" 
						           class="d-flex align-items-center gap-1" 
						           style="cursor:pointer;">
						         <img src="https://img.icons8.com/ios/18/888888/comments.png" 
						              alt="コメント" 
						              style="width:14px; height:14px;">
						         <span th:text="${comment.replies.size()}">0</span>
						     </span>
						     
						     <span th:if="${session.loginUser != null && comment.user != null && session.loginUser.userId == comment.user.userId}"
							       th:onclick="'checkLoginAndToggleEdit(event,' + ${comment.id} + ')'" 
							       style="cursor:pointer;">
							     ✔️ 編集
							 </span>
						     
						     <!-- 삭제 -->
						     <form th:if="${session.loginUser != null && comment.user != null && session.loginUser.userId == comment.user.userId}"
							       th:action="@{/board/comment/delete}" method="post"
							       class="d-inline"
							       onsubmit="return checkLoginForAction(event) && confirm('本当に削除しますか?');">
						         <input type="hidden" name="commentId" th:value="${comment.id}">
								 <input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
						         <button type="submit" class="btn-action">
						             ✖️ 削除
						         </button>
						     </form>
						 </div>
                
					<!-- 대댓글 입력 폼 -->
					<div class="reply-form" th:id="'reply-form-' + ${comment.id}">
					    <form th:action="@{/board/comment/reply}" method="post" onsubmit="return checkLoginForAction(event)">
					        <input type="hidden" name="parentId" th:value="${comment.id}">
							<input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
					        <textarea name="content" 
					                  class="form-control mb-2" 
					                  placeholder="コメントを入力してください"
					                  onclick="checkLoginForClick(event)" 
					                  required></textarea>
					        <div class="d-flex gap-2">
					            <button type="submit" class="btn btn-sm btn-danger">登録</button>
					            <button type="button" class="btn btn-sm btn-secondary"
					                    th:onclick="'toggleReply(' + ${comment.id} + ')'">キャンセル</button>
					        </div>
					    </form>
					</div>
                
                <!-- 대댓글 목록 -->
                <div class="reply bg-light rounded px-2 py-2 ms-4 mt-2" th:each="reply : ${comment.replies}">
                  
					<div class="d-flex align-items-center gap-2 mb-2">
					       <!-- 프로필 이미지 -->
					       <div th:if="${reply.user != null && reply.user.profileImageUrl != null}"
					            class="profile tiny"
					            th:style="'background-image: url(' + ${reply.user.profileImageUrl} + '); background-size: cover; background-position: center;'">
					       </div>
					       <div th:unless="${reply.user != null && reply.user.profileImageUrl != null}"
					            class="profile tiny">
					       </div>
					       
					       <!-- 사용자 이름 -->
					       <span class="fw-semibold small" 
					             th:text="${reply.user != null ? reply.user.name : reply.author}">
					           ユーザー
					       </span>
					       
					       <span class="text-muted small" 
					             th:text="${reply.createdAt != null ? #temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm') : '2026-01-19 14:35'}">
					           2026-01-19 14:35
					       </span>
					   </div>
                    
                    <!-- 대댓글 내용 -->
                    <div class="mb-2 small" th:text="${reply.content}" 
                         th:id="'reply-content-' + ${comment.id} + '-' + ${reply.id}">
                        コメント内容
                    </div>
                    
                    <!-- 대댓글 수정 폼 -->
                    <div class="edit-form" th:id="'reply-edit-form-' + ${comment.id} + '-' + ${reply.id}">
                        <form th:action="@{/board/comment/reply/edit}" method="post" onsubmit="return checkLoginForAction(event)">
                            <input type="hidden" name="parentId" th:value="${comment.id}">
                            <input type="hidden" name="replyId" th:value="${reply.id}">
							<input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
                            <textarea name="content" class="form-control mb-2" th:text="${reply.content}" required></textarea>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-primary">保存</button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        th:onclick="'toggleReplyEdit(' + ${comment.id} + ',' + ${reply.id} + ')'">キャンセル</button>
                            </div>
                        </form>
                    </div>
                    
					<div class="comment-actions">
					    <!-- 대댓글 좋아요 -->
						<form th:action="@{/board/comment/reply/like}" method="post" class="d-inline" onsubmit="return checkLoginForAction(event)">
						        <input type="hidden" name="parentId" th:value="${comment.id}">
						        <input type="hidden" name="replyId" th:value="${reply.id}">
								<input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
						        <button type="submit" class="btn-action d-flex align-items-center gap-1">
						            <img th:src="${reply.likedByMe ? 'https://img.icons8.com/ios-filled/16/ff6b6b/like.png' : 'https://img.icons8.com/ios/16/888888/like.png'}" 
						                 alt="いいね" 
						                 style="width:12px; height:12px;">
						            <span th:text="${reply.likeCount}">0</span>
						        </button>
						    </form>
						    
						    <span th:if="${session.loginUser != null && reply.user != null && session.loginUser.userId == reply.user.userId}"
							      th:onclick="'checkLoginAndToggleReplyEdit(event,' + ${comment.id} + ',' + ${reply.id} + ')'" 
							      style="cursor:pointer;">
							    ✔️ 編集
							</span>
						    
						    <!-- 대댓글 삭제 -->
						    <form th:if="${session.loginUser != null && reply.user != null && session.loginUser.userId == reply.user.userId}"
							      th:action="@{/board/comment/reply/delete}" method="post" 
							      class="d-inline"
							      onsubmit="return checkLoginForAction(event) && confirm('本当に削除しますか?');">
						        <input type="hidden" name="parentId" th:value="${comment.id}">
						        <input type="hidden" name="replyId" th:value="${reply.id}">
								<input type="hidden" name="returnUrl" value="post">  <!-- ✅ 추가 -->
						        <button type="submit" class="btn-action">
						            ✖️ 削除
						        </button>
						    </form>
						</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ 추가: 서버의 로그인 상태를 JavaScript 변수로 전달 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const isLoggedIn = /*[[${isLoggedIn}]]*/ false;
    /*]]>*/
</script>

<!-- Bootstrap JS -->
<script th:src="@{/js/post.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Bottom Navigation Bar -->
<div th:replace="~{fragments/bottom-nav :: bottomNav}"></div>

</body>
</html>